#-----------------------------------------#
# Production HTTPS site
#
# See:
#   - https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04
#   - https://bjornjohansen.no/redirect-to-https-with-nginx
#-----------------------------------------#
server {
    listen                      443 ssl http2 default_server;
    listen                      [::]:443 ssl http2 default_server;

    ssl_certificate             /etc/letsencrypt/live/{{ first_domain }}/fullchain.pem;
    ssl_certificate_key         /etc/letsencrypt/live/{{ first_domain }}/privkey.pem;

    ssl_session_cache           shared:SSL:20m;
    ssl_session_timeout         60m;
    ssl_prefer_server_ciphers   on;
    ssl_ciphers                 ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;
    ssl_dhparam                 /etc/ssl/certs/dhparam.pem;
    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_stapling                on;
    ssl_stapling_verify         on;
    add_header                  Strict-Transport-Security "max-age=31536000" always;

    server_name                 {{ all_domains }};

    root                        /opt/quartic/www.quartic.io;
    index                       index.html;

    error_page 404 403 /_super_secret/404.html;

    location ~ /\. {
       deny all;
    }

    location / {
        try_files $uri $uri/ =404;
    }
}

#-----------------------------------------#
# Test site
#-----------------------------------------#
server {
    listen                      80;
    listen                      [::]:80;

    server_name                 {{ test_domains }};

    root                        /opt/quartic/www-test.quartic.io;
    index                       index.html;

    error_page 404 403 /_super_secret/404.html;

    location ~ /\. {
       deny all;
    }

    location / {
        try_files $uri $uri/ =404;
        auth_basic              "Restricted Content";
        auth_basic_user_file    .htpasswd;
    }
}

#-----------------------------------------#
# Non-HTTPS
#-----------------------------------------#
server {
    listen                      80;
    listen                      [::]:80;

    server_name                 {{ all_domains }};

    # For letsencrypt bootstrapping
    location /.well-known {
      root                      /var/www/html;
      try_files $uri $uri/ =404;
    }

    location / {
      return                    301 https://$host$request_uri;
    }
}
